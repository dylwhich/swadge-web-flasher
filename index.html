<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Swadge Firmware Updater</title>
    <meta
      name="description"
      content="Update your MAGFest Swadge to the latest firmware without installing stuff"
    />
    <meta name="viewport" content="width=device-width" />
    <meta name="color-scheme" content="dark light" />
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@4.19.0/css/xterm.css">
    <script type="module" src="https://cdn.jsdelivr.net/npm/xterm@4.19.0/lib/xterm.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.js"></script>
    <script type="text/javascript">
      window.manifests = {
        pulse: {
          year: "2026",
          desc: "Pulse Helmet Updated Firmware",
          userVersion: "3.1",
          chipFamily: "ESP32-S2",
          baudrate: 115200,
          flashMode: "DIO",
          flashFreq: "80m",
          flashSize: "4MB",
          parts: [
            { "path": "firmware/2026/bootloader.bin", "offset": 0x1000 },
            { "path": "firmware/2026/partitions.bin", "offset": 0x8000 },
            { "path": "firmware/2026/swadge.bin", "offset": 0x10000 },
          ]
        }
      }
    </script>
  </head>
  <body>
    <div class="content">
      <h1>Swadge Firmware Updater</h1>
      <div id="swadge-select-container">
        <p>What kind of Swadge do you have?</p>
        <ul class="radios">
          <li>
            <label><input type="radio" name="type" value="pulse" /><img src="images/pulse-thumbnail.png" alt="An image of the 2026 MAGFest Swadge, which is shaped like a helmet."/><caption> Pulse Helmet (2026)</caption></label>
          </li>
          <!--<li>
            <label><input type="radio" name="type" value="chilidog" /> Chili Dog (2025)</label>
          </li>
          <li>
            <label><input type="radio" name="type" value="gunship" /> Gunship (2024)</label>
          </li>
          <li>
            <label><input type="radio" name="type" value="squarewavebird" /> Squarewavebird (2023)</label>
          </li>-->
        </ul>
      </div>
      <div id="instructions-container">
        <div id="instructions-pulse" class="instructions hidden">
          <img src="images/pulse-render-annotated.png" alt="An image of the 2026 MAGFest Swadge, with two annotations indicating the position of the Program button and the Power Switch. The Program button is the &quot;Up&quot; button in the directional pad on the left-hand side, labeled &quot;PGM&quot;. The Power switch is located on the top edge of the swadge, above the &quot;A&quot; button." />
          <ol>
            <li>Connect one end of a USB-C cable to your Swadge's USB-C port, located next to the power switch.</li>
            <li>Set your Swadge's power switch to the <code>USB</code> position.</li>
            <li>Hold down the Swadge's Program button (Up on the D-Pad).</li>
            <li>While still holding down the Program button, plug the other end of the USB cable into your computer.
              If this is done correctly, the eye LEDs should light up but the display should <em>not</em> turn on.<br/>
            <img src="images/pulse-flash-mode-comparison.png" alt="A comparison of two images of the Swadge. The image on the left has illuminated eye LEDs and a blank display and has the label &quot;OK!&quot;. The image on the left has illuminated eye LEDs and the display shows the main menu, with the label &quot;Not OK&quot;" /></li>
            <li>Release the Program button.</li>
            <li>Click &quot;Connect&quot; below to locate your Swadge and begin the update.</li>
          </ol>
        </div>
      </div>

      <div id="unsupported-message" class="error-message hidden">
        <p>
          Oh no! Your browser does not support WebSerial. Supported browsers are Google Chrome/Chromium, Microsoft Edge, or Opera. Mobile browsers are not supported.
          Please either use a supported browser, or download the <a href="https://github.com/AEFeinstein/Super-2024-Swadge-FW/releases/download/v3.1.0/9b7b99f_swadge2024-firmware.zip">Flashing Utility</a> and follow <a href="pyflashgui.html">the Flashing Utility instructions</a>.
        </p>
      </div>
      <div id="not-found-message" class="error-message hidden">
        <p>
          No Swadge was found! Please ensure you are holding Up button before plugging the Swadge in.
          You may also try removing the Swadge's batteries and connecting the USB cable between your
          Swadge and Computer, then sliding the power switch from <code>BATT</code> to <code>USB</code>
          while holding Up on the D-Pad.
        </p>
        <p>
          You may need to install a driver in order to connect the Swadge. These drivers can be installed by the <a href="https://zadig.akeo.ie/">Zadig tool</a>.
          Please make sure that the device is in flashing mode before running the tool and that it detects the ESP32-S2 device before installing the drivers.
          The Zadig tool might detect several USB interfaces of ESP32-S2.
          Please install the WinUSB driver for only that interface for which there is no driver installed (probably it is Interface 2) and don't re-install the driver for the other interface.
        </p>
      </div>
      <div id="fetch-error-message" class="error-message hidden">
        <p>
          There was an error fetching firmware data. Please try again!
        </p>
      </div>
      <div id="post-flash-instructions" class="hidden">
        <h3>It's done!</h3>
        <p>
          Now, unplug your Swadge, then turn it back on. You should see the main menu, with the updated title showing &quot;Swadge 3.1&quot; as in the image below.
          If you do not see the new version listed, then the update was not successful and you should try again.
          If the Swadge's display does not turn on, then the update may have been interrupted and you should try again.<br/>
          <img src="images/pulse-success-screen.png" alt="A screenshot of the Swadge main menu display. It shows the title &quot;Swadge 3.2&quot; above the five main menu items &quot;Games&quot;, &quot;Music&quot;, &quot;Utilities&quot;, &quot;SwadgePass&quot;, and &quot;Settings&quot;." />
        </p>
      </div>

      <button id="connect-button" class="big-button invisible">Connect</button>
      <button id="retry-button" class="big-button hidden">Retry</button>
      <!--<button id="disconnect-button" class="big-button hidden">Disconnect</button>-->

      <div id="terminal"></div>

      <div id="alternate-instructions">
        <p>
          If you are having trouble using this tool, you may instead download the <a href="https://github.com/AEFeinstein/Super-2024-Swadge-FW/releases/download/v3.1.0/9b7b99f_swadge2024-firmware.zip">Flashing Utility</a> and follow <a href="pyflashgui.html">the Flashing Utility instructions</a>.
        </p>
      </div>

      <div class="footer">
        For the <a href="https://magfest.org">MAGFest</a> <a href="https://swadge.com">Swadge</a> &bull;
        <a href="mailto:circuitboards@magfest.org">E-Mail</a> &bull;
        <a href="https://discord.magfest.org">Discord</a> (#tech) &mdash;
        Installer powered by <a href="https://github.com/espressif/esptool-js/">esptool-js</a>
    </div>
    <script type="module">
      import {
        ESPLoader,
        Transport
      } from "https://unpkg.com/esptool-js@0.5.6/bundle.js";

      // Fix the path so assets don't load from the root instead of relative to index.html
      var lastChar = window.location.href.substr(-1);
      if (lastChar != '/') {
        window.location.href = window.location.href + '/';
      }

      if (!navigator.serial)
      {
        console.log("No serial? :(");
        document.getElementById("unsupported-message").classList.remove("hidden");
        document.getElementById("swadge-select-container").classList.add("hidden");
      }

      async function fetchData(path) {
        const response = await fetch(path);
        console.log("Fetched", response);
        if (!response.ok) {

          throw new Error("Could not fetch firmware data");
        }

        return new Uint8Array(await response.arrayBuffer());
      }

      async function fetchFirmware(manifest) {
        try {
          return await Promise.all(manifest.parts.map(async ({path, offset}) => {
            console.log("Fetching", path);
            const result = { data: ESPLoader.prototype.ui8ToBstr(await fetchData(path)), address: offset };
            console.log("Result:");
            console.log(result);
            return result;
          }));
        } catch (e) {
          console.error(e);
        }
      }

      async function doFlash(device, manifest, fileArray, terminal) {
        console.log("Firmwares", fileArray);

        let esploader = window.esploader;
        if (!esploader) {
          esploader = new ESPLoader({
            transport: new Transport(device, true),
            baudrate: manifest.baudrate,
            terminal: terminal,
            debugLogging: false,
          });
          window.esploader = esploader;
        }

        try {
          let chip = window.chip;
          if (!chip) {
            chip = await esploader.main();
            window.chip = chip;
          }

          terminal.writeLine(`Chip detected: ${chip}`);

          console.log("fileArray:");
          console.warn(fileArray);

          await esploader.writeFlash({
            fileArray: fileArray,
            eraseAll: false,
            compress: true,
            flashMode: manifest.flashMode,
            flashFreq: manifest.flashFreq,
            flashSize: manifest.flashSize,
            reportProgress: (fileIndex, written, total) => {
              console.log("...");
            },
            calculateMD5Hash: (image) => {
              return CryptoJS.MD5(CryptoJS.enc.Latin1.parse(image)).toString();
            }
          });
          console.log("Eyyy");
          await esploader.after();
          console.log("Yoooo it's done");

          // Re-hide everything
          document.querySelectorAll("#instructions-container .instructions").forEach(button => button.classList.add("hidden"));
          document.getElementById("post-flash-instructions").classList.remove("hidden");
          window.scrollTo(0, 0);

        } catch (e) {
          console.log(e);

          document.querySelectorAll("error-message").forEach(err => err.classList.add("hidden"));
          document.getElementById("connect-button").classList.add("invisible");
          document.getElementById("swadge-select-container").classList.add("hidden");

          throw e;
        }
      }

      // Show only the relevant instructions when the radio changes
      document.querySelectorAll('input[name="type"]').forEach(radio =>
        radio.addEventListener("change", () => {
          window.boardType = radio.value;
          document.querySelectorAll("#instructions-container .instructions").forEach(button => button.classList.add("hidden"));
          document.getElementById(`instructions-${radio.value}`).classList.remove("hidden");
          document.getElementById("connect-button").classList.remove("invisible");
        })
      );

      const portFilters = [
        // ESP32 vendor ID
        { usbVendorId: 0x303a, usbProductId: 0x0002 },
        // MAGFest Swadge ID (just in case)
        { usbVendorId: 0x1209, usbProductId: 0x4269 },
      ];
      document.getElementById("retry-button").onclick = function() {
        if (window.connectedDevice && window.connectedDevice.connected && window.fileArray) {
          window.connectedDevice.close();
          doFlash(window.connectedDevice, window.manifests[window.boardType], window.fileArray, window.espLoaderTerminal).then(() => {
            console.log("It done");
          }).catch((err) => {
            console.log("Err", err);
            window.espLoaderTerminal.writeLine(err.toString());
          });
        }
      };

      document.getElementById("connect-button").onclick = function() {
        // Reset error messages
        document.querySelectorAll("error-message").forEach(err => err.classList.add("hidden"));
        document.getElementById("connect-button").classList.add("invisible");
        document.getElementById("swadge-select-container").classList.add("hidden");

        navigator.serial.requestPort({ filters: portFilters }).then(function(device) {
          window.connectedDevice = device;
          console.log("Connected to device:", device);
          console.log("Board type", window.boardType);

          device.ondisconnect = function() {
            document.getElementById("retry-button").classList.add("hidden");
            document.getElementById("connect-button").classList.remove("invisible");

            if (window.espLoaderTerminal) {
              window.espLoaderTerminal.writeLine("Device Disconnected");
            }
            window.chip = undefined;
            window.esploader = undefined;
            window.device = undefined;
          };

          let manifest = window.manifests[window.boardType];

          console.log(`Flashing ${manifest.year}: '${manifest.desc}' version ${manifest.version}`);

          fetchFirmware(manifest).then((fileArray) => {
            console.log("Flashing with files", fileArray);
            window.fileArray = fileArray;

            // Show and initialize the terminal
            document.getElementById("terminal").classList.remove("hidden");
            const terminal = new Terminal({ cols: 80, rows: 24 });
            terminal.open(document.getElementById("terminal"));

            document.querySelectorAll("#instructions-container .instructions").forEach(button => button.classList.add("hidden"));
            window.scrollTo(0, 0);

            const espLoaderTerminal = {
              clean() {
                terminal.clear();
              },
              writeLine(data) {
                terminal.writeln(data);
              },
              write(data) {
                terminal.write(data);
              }
            };

            window.espLoaderTerminal = espLoaderTerminal;

            doFlash(device, manifest, fileArray, espLoaderTerminal).then(() => {
              console.log("It done");
            }).catch((err) => {
              console.log("Err", err);
              terminal.writeln(err.toString());
              document.getElementById("connect-button").classList.add("invisible");
              document.getElementById("retry-button").classList.remove("hidden");
            });
          }).catch((e) => {
            terminal.writeln("Could not fetch files!");
          });
        }, function(e) {
          // No serial port found, probably swadge isn't in flashing mode
          document.getElementById("not-found-message").classList.remove("hidden");
          document.getElementById("connect-button").classList.remove("invisible");
          document.getElementById("swadge-select-container").classList.remove("hidden");
        });
      };
    </script>
  </body>
</html>
